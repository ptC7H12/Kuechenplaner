{% extends "base.html" %}

{% block title %}Mahlzeitenplanung - {{ current_camp.name }}{% endblock %}

{% block content %}
<div class="space-y-6" x-data="mealPlanning()">
    <!-- Info Card -->
    {% with
        variant="purple",
        icon='<div class="w-14 h-14 bg-purple-500 rounded-xl flex items-center justify-center text-white shadow-lg"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div>',
        title="Mahlzeitenplanung",
        content="<p class='leading-relaxed'>Ziehen Sie Rezepte per Drag & Drop in den Kalender.</p>"
    %}
        {% include "components/info_card.html" %}
    {% endwith %}

    <!-- Planning Interface -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Recipe Sidebar -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200 sticky top-4">
                <div class="px-6 py-5 border-b-2 border-gray-200 bg-gradient-to-br from-white to-gray-50">
                    <h2 class="text-xl font-black text-gray-900">Verfügbare Rezepte</h2>
                    <p class="text-sm font-bold text-gray-600 mt-1">{{ recipes|length }} Rezepte</p>
                </div>

                <!-- Search -->
                <div class="px-6 py-4 border-b-2 border-gray-200">
                    <input
                        type="text"
                        x-model="searchQuery"
                        @input="filterRecipes()"
                        placeholder="Rezepte suchen..."
                        class="form-input"
                    >
                </div>

                <!-- Recipe List -->
                <div id="recipe-sidebar" class="p-4 space-y-2 max-h-[600px] overflow-y-auto">
                    <!-- "Kein Essen" Option -->
                    <div class="recipe-card-draggable bg-red-200 hover:bg-red-300 transition-colors"
                         data-recipe-id="0"
                         data-recipe-name="Kein Essen">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 bg-red-400 rounded flex items-center justify-center mr-2">
                                <svg class="w-5 h-5 text-red-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-sm text-red-900 truncate">Kein Essen</h4>
                                <p class="text-xs text-red-800 font-medium">Keine Mahlzeit geplant</p>
                            </div>
                        </div>
                    </div>

                    {% if recipes %}
                        {% for recipe in recipes %}
                        <div class="recipe-card-draggable"
                             data-recipe-id="{{ recipe.id }}"
                             data-recipe-name="{{ recipe.name }}"
                             x-show="filteredRecipes.includes({{ recipe.id }})">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-8 h-8 bg-indigo-100 rounded flex items-center justify-center mr-2">
                                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-medium text-sm text-gray-900 truncate">{{ recipe.name }}</h4>
                                    {% if recipe.preparation_time %}
                                    <p class="text-xs text-gray-600">
                                        {{ recipe.preparation_time + (recipe.cooking_time or 0) }} min
                                    </p>
                                    {% endif %}
                                    {% if recipe.tags %}
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        {% for tag in recipe.tags[:2] %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800">
                                            {{ tag.name }}
                                        </span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-sm">Keine Rezepte vorhanden</p>
                            <a href="/recipes/create" class="text-indigo-600 hover:text-indigo-700 text-sm underline mt-2 inline-block">
                                Rezept erstellen
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200">
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-300 bg-gradient-to-r from-gray-50 to-gray-100">
                                <th class="text-left py-5 px-4 font-black text-gray-900 w-48 sticky left-0 bg-gradient-to-r from-gray-50 to-gray-100 z-10">
                                    Tag
                                </th>
                                <!-- Frühstück -->
                                <th class="text-center py-5 px-3 font-black text-gray-900 min-w-[200px] bg-yellow-50">
                                    <div class="flex items-center justify-center">
                                        <svg class="w-5 h-5 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                        </svg>
                                        <span>Frühstück</span>
                                    </div>
                                </th>
                                <!-- Mittagessen -->
                                <th class="text-center py-5 px-3 font-black text-gray-900 min-w-[200px] bg-green-50">
                                    <div class="flex items-center justify-center">
                                        <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                                        </svg>
                                        <span>Mittagessen</span>
                                    </div>
                                </th>
                                <!-- Abendessen -->
                                <th class="text-center py-5 px-3 font-black text-gray-900 min-w-[200px] bg-indigo-50">
                                    <div class="flex items-center justify-center">
                                        <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                        </svg>
                                        <span>Abendessen</span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for day in days %}
                            {% set date_key = day.date() %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="py-4 px-4 font-bold text-gray-900 border-r-2 border-gray-200 sticky left-0 bg-white z-10">
                                    <div class="text-base">{{ day.strftime('%A') }}</div>
                                    <div class="text-sm text-gray-600 font-semibold">{{ day.strftime('%d.%m.%Y') }}</div>
                                </td>

                                {% set meal_config = [
                                    ('BREAKFAST', 'Frühstück', 'yellow'),
                                    ('LUNCH', 'Mittagessen', 'green'),
                                    ('DINNER', 'Abendessen', 'indigo')
                                ] %}
                                {% for meal_type_value, label, color in meal_config %}
                                {% set meal_type = namespace(enum=None) %}
                                {% for mt in meal_types %}
                                    {% if mt.value == meal_type_value %}
                                        {% set meal_type.enum = mt %}
                                    {% endif %}
                                {% endfor %}
                                {% set meals = meal_grid.get(date_key, {}).get(meal_type.enum, []) %}
                                <td class="py-2 px-2 align-top bg-{{ color }}-50">
                                    <div
                                        class="meal-cell-dropzone min-h-[120px] rounded-lg"
                                        data-meal-date="{{ day.strftime('%Y-%m-%d') }}"
                                        data-meal-type="{{ meal_type_value }}"
                                        data-camp-id="{{ current_camp.id }}"
                                    >
                                        {% if meals %}
                                            {% for meal_plan in meals %}
                                            <div class="recipe-card-planned {% if not meal_plan.recipe_id %}bg-red-200{% endif %}"
                                                 data-meal-plan-id="{{ meal_plan.id }}"
                                                 data-recipe-id="{{ meal_plan.recipe_id or 0 }}">
                                                <div class="flex items-start">
                                                    <button @click="deleteMealPlan({{ meal_plan.id }})"
                                                            class="mr-2 btn btn-icon text-red-600 hover:bg-red-50 flex-shrink-0">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                                        </svg>
                                                    </button>
                                                    <div class="flex-1 min-w-0">
                                                        {% if meal_plan.recipe_id %}
                                                            <h4 class="font-bold text-sm text-gray-900 truncate">{{ meal_plan.recipe.name }}</h4>
                                                            {% if meal_plan.notes %}
                                                            <p class="text-xs text-gray-500 mt-1 italic truncate font-medium">{{ meal_plan.notes }}</p>
                                                            {% endif %}
                                                        {% else %}
                                                            <div class="flex items-center">
                                                                <svg class="w-4 h-4 text-red-900 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                                </svg>
                                                                <h4 class="font-bold text-sm text-red-900 truncate">Kein Essen</h4>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="empty-placeholder text-center text-gray-400 text-xs py-12 h-full flex items-center justify-center">
                                                <span>Rezept hier ablegen</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
function mealPlanning() {
    return {
        searchQuery: '',
        filteredRecipes: {{ recipes | map(attribute='id') | list | tojson }},

        init() {
            this.initializeDragAndDrop();
        },

        filterRecipes() {
            const query = this.searchQuery.toLowerCase();
            if (!query) {
                this.filteredRecipes = {{ recipes | map(attribute='id') | list | tojson }};
                return;
            }

            this.filteredRecipes = [];
            {% for recipe in recipes %}
            if ('{{ recipe.name }}'.toLowerCase().includes(query)) {
                this.filteredRecipes.push({{ recipe.id }});
            }
            {% endfor %}
        },

        initializeDragAndDrop() {
            // Make recipe sidebar sortable (clone only)
            const sidebar = document.getElementById('recipe-sidebar');
            if (sidebar && typeof Sortable !== 'undefined') {
                new Sortable(sidebar, {
                    group: {
                        name: 'recipes',
                        pull: 'clone',
                        put: false
                    },
                    sort: false,
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen'
                });
            }

            // Make meal cells sortable (accept drops)
            document.querySelectorAll('.meal-cell-dropzone').forEach(zone => {
                if (typeof Sortable !== 'undefined') {
                    new Sortable(zone, {
                        group: {
                            name: 'recipes',
                            pull: true,
                            put: true
                        },
                        animation: 150,
                        ghostClass: 'sortable-ghost',

                        onAdd: async (evt) => {
                            const recipeId = evt.item.dataset.recipeId;
                            const recipeName = evt.item.dataset.recipeName;
                            const mealDate = evt.to.dataset.mealDate;
                            const mealType = evt.to.dataset.mealType;
                            const campId = evt.to.dataset.campId;

                            // Remove the placeholder if it exists
                            const placeholder = evt.to.querySelector('.empty-placeholder');
                            if (placeholder) {
                                placeholder.remove();
                            }

                            // Remove the cloned draggable element
                            evt.item.remove();

                            // Calculate position (number of existing recipes)
                            const existingRecipes = evt.to.querySelectorAll('.recipe-card-planned');
                            const position = existingRecipes.length;

                            // Make API call to save meal plan
                            try {
                                const requestBody = {
                                    camp_id: parseInt(campId),
                                    recipe_id: recipeId === '0' ? null : parseInt(recipeId),
                                    meal_date: mealDate + 'T00:00:00',
                                    meal_type: mealType,
                                    position: position
                                };

                                const response = await fetch('/meal-planning/api/meal-plans', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify(requestBody)
                                });

                                if (response.ok) {
                                    // Reload the page to show updated meal plan
                                    window.location.reload();
                                    window.FreizeitApp.showToast(`"${recipeName}" hinzugefügt`, 'success');
                                } else {
                                    throw new Error('Failed to save meal plan');
                                }
                            } catch (error) {
                                console.error('Error saving meal plan:', error);
                                window.FreizeitApp.showToast('Fehler beim Hinzufügen des Rezepts', 'error');
                            }
                        },

                        onUpdate: async (evt) => {
                            const mealPlanId = evt.item.dataset.mealPlanId;
                            if (mealPlanId) {
                                // Update position when reordering within same cell
                                try {
                                    await fetch(`/meal-planning/api/meal-plans/${mealPlanId}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            position: evt.newIndex
                                        })
                                    });
                                } catch (error) {
                                    console.error('Error updating position:', error);
                                }
                            }
                        }
                    });
                }
            });
        },

        async deleteMealPlan(mealPlanId) {
            if (!confirm('Möchten Sie dieses Rezept wirklich aus dem Plan entfernen?')) {
                return;
            }

            try {
                const response = await fetch(`/meal-planning/api/meal-plans/${mealPlanId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Reload the page to show updated meal plan
                    window.location.reload();
                    window.FreizeitApp.showToast('Rezept entfernt', 'success');
                } else {
                    throw new Error('Failed to delete meal plan');
                }
            } catch (error) {
                console.error('Error deleting meal plan:', error);
                window.FreizeitApp.showToast('Fehler beim Entfernen des Rezepts', 'error');
            }
        }
    };
}
</script>

{% endblock %}

{% block fab %}
<div class="fab-container">
    <!-- Plan exportieren (PDF) - Primary FAB -->
    <a href="/export/meal-plan/pdf/{{ current_camp.id }}"
       class="fab-extended fab-extended-primary"
       title="Plan exportieren (PDF)">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"></path>
        </svg>
        <span>PDF Export</span>
    </a>

    <!-- Rezeptbuch (PDF) - Secondary FAB -->
    <a href="/export/recipe-book/pdf/{{ current_camp.id }}"
       class="fab-extended fab-extended-accent"
       title="Rezeptbuch (PDF)">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path>
        </svg>
        <span>Rezeptbuch</span>
    </a>
</div>
{% endblock %}
