{% extends "base.html" %}

{% block title %}Rezept bearbeiten - {{ recipe.name }}{% endblock %}

{% block page_title %}Rezept bearbeiten{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Back Button -->
    <div class="mb-6">
        <a href="/recipes/{{ recipe.id }}" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 font-semibold transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Zurück zum Rezept
        </a>
    </div>

    <!-- Version Info -->
    <div class="alert alert-info mb-6 flex items-center">
        <svg class="w-6 h-6 mr-3 flex-shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
            <p class="font-bold">Version {{ recipe.version_number }}</p>
            <p class="text-sm">Änderungen werden als neue Version gespeichert.</p>
        </div>
    </div>

    <!-- Recipe Form -->
    <form
        id="recipe-form"
        x-data="recipeForm()"
        x-init="init()"
        @submit.prevent="submitForm"
        class="space-y-6"
    >
        <!-- Section 1: Grundinformationen -->
        <div class="card">
            <div class="card-header">
                <h2 class="text-2xl font-extrabold text-gray-900 flex items-center">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 font-bold mr-4 text-lg">1</span>
                    Grundinformationen
                </h2>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <!-- Name -->
                <div class="form-group">
                    <label for="name" class="form-label text-base">
                        <span class="text-gray-900">Name des Rezepts</span> <span class="text-red-500 text-lg">*</span>
                    </label>
                    <p class="form-help mb-2">Geben Sie einen aussagekräftigen Namen für das Rezept ein.</p>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        x-model="formData.name"
                        class="form-input"
                        placeholder="z.B. Spaghetti Bolognese"
                        required
                    >
                    <p x-show="errors.name" x-text="errors.name" class="form-error"></p>
                </div>

                <!-- Beschreibung -->
                <div class="form-group">
                    <label for="description" class="form-label text-base">
                        <span class="text-gray-900">Beschreibung</span>
                    </label>
                    <p class="form-help mb-2">Optional: Eine kurze Beschreibung oder besondere Hinweise zum Rezept.</p>
                    <textarea
                        id="description"
                        name="description"
                        x-model="formData.description"
                        class="form-textarea"
                        rows="5"
                        placeholder="z.B. Ein klassisches italienisches Gericht, perfekt für große Gruppen..."
                    ></textarea>
                </div>

                <!-- Portionen -->
                <div class="form-group">
                    <label for="base_servings" class="form-label text-base">
                        <span class="text-gray-900">Anzahl Portionen (Standard)</span> <span class="text-red-500 text-lg">*</span>
                    </label>
                    <p class="form-help mb-2">Für wie viele Personen ist dieses Rezept in der Grundversion ausgelegt?</p>
                    <input
                        type="number"
                        id="base_servings"
                        name="base_servings"
                        x-model.number="formData.base_servings"
                        class="form-input"
                        min="1"
                        required
                    >
                </div>
            </div>
        </div>

        <!-- Section 2: Zeiten -->
        <div class="card">
            <div class="card-header">
                <h2 class="text-2xl font-extrabold text-gray-900 flex items-center">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 font-bold mr-4 text-lg">2</span>
                    Zeiten
                </h2>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <!-- Vorbereitungszeit -->
                <div class="form-group">
                    <label for="preparation_time" class="form-label text-base">
                        <span class="text-gray-900">Vorbereitungszeit (Minuten)</span>
                    </label>
                    <p class="form-help mb-2">Optional: Zeit für das Vorbereiten der Zutaten (Schneiden, Abwiegen, etc.).</p>
                    <input
                        type="number"
                        id="preparation_time"
                        name="preparation_time"
                        x-model.number="formData.preparation_time"
                        class="form-input"
                        min="0"
                        placeholder="z.B. 15"
                    >
                </div>

                <!-- Kochzeit -->
                <div class="form-group">
                    <label for="cooking_time" class="form-label text-base">
                        <span class="text-gray-900">Kochzeit (Minuten)</span>
                    </label>
                    <p class="form-help mb-2">Optional: Zeit für das Kochen, Backen oder Braten.</p>
                    <input
                        type="number"
                        id="cooking_time"
                        name="cooking_time"
                        x-model.number="formData.cooking_time"
                        class="form-input"
                        min="0"
                        placeholder="z.B. 30"
                    >
                </div>
            </div>
        </div>

        <!-- Section 3: Zutaten -->
        <div class="card">
            <div class="card-header">
                <h2 class="text-2xl font-extrabold text-gray-900 flex items-center">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 font-bold mr-4 text-lg">3</span>
                    Zutaten <span class="text-red-500">*</span>
                </h2>
            </div>

            <!-- Ingredient Add Form -->
            <div class="bg-gradient-to-br from-teal-50 to-emerald-50 border-2 border-teal-200 rounded-xl p-6 mb-6">
                <h3 class="text-xl font-extrabold text-gray-900 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                    Zutat hinzufügen
                </h3>

                <div class="grid grid-cols-1 gap-4">
                    <!-- Zutat (Autocomplete) -->
                    <div>
                        <label class="form-label text-base">
                            <span class="text-gray-900">Zutat</span> <span class="text-red-500 text-lg">*</span>
                        </label>
                        <p class="form-help mb-2">Suchen Sie nach einer vorhandenen Zutat oder erstellen Sie eine neue.</p>

                        <!-- Suchfeld -->
                        <div class="relative" x-data="ingredientAutocomplete()">
                            <input
                                type="text"
                                x-model="search"
                                @input.debounce.300ms="searchIngredients"
                                @focus="showSuggestions = search.length >= 1"
                                @keydown.down.prevent="navigateDown"
                                @keydown.up.prevent="navigateUp"
                                @keydown.enter.prevent="selectCurrent"
                                @keydown.escape="showSuggestions = false"
                                class="form-input"
                                placeholder="Zutat suchen..."
                                :disabled="currentIngredient.id !== null"
                            >

                        <!-- Autocomplete Dropdown -->
                        <div
                            x-show="showSuggestions && suggestions.length > 0"
                            x-cloak
                            @click.away="showSuggestions = false"
                            class="absolute z-50 w-full mt-2 bg-white border-2 border-gray-300 rounded-lg shadow-xl max-h-80 overflow-auto"
                        >
                            <template x-for="(suggestion, index) in suggestions" :key="suggestion.id">
                                <div
                                    @click="selectSuggestion(suggestion)"
                                    :class="selectedIndex === index ? 'bg-indigo-100' : 'hover:bg-gray-50'"
                                    class="px-4 py-3 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors"
                                >
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="font-bold text-gray-900" x-text="suggestion.name"></p>
                                            <p class="text-xs text-gray-500 mt-1">
                                                <span class="inline-flex items-center">
                                                    <span class="font-semibold" x-text="suggestion.category"></span>
                                                    <span class="mx-2">•</span>
                                                    <span x-text="suggestion.usage_count + 'x verwendet'"></span>
                                                </span>
                                            </p>
                                        </div>
                                        <span class="text-sm text-gray-600 ml-4" x-text="suggestion.unit"></span>
                                    </div>
                                </div>
                            </template>

                            <!-- Option: New Ingredient -->
                            <div
                                @click="openNewIngredientModal"
                                class="px-4 py-3 cursor-pointer bg-indigo-50 hover:bg-indigo-100 transition-colors border-t-2 border-indigo-200"
                            >
                                <p class="text-indigo-700 font-bold flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
                                    </svg>
                                    "<span x-text="search"></span>" als neue Zutat hinzufügen
                                </p>
                            </div>
                        </div>
                        </div>

                        <!-- Ausgewählte Zutat Badge -->
                        <div x-show="currentIngredient.id" class="mt-2 inline-flex items-center px-4 py-2 rounded-lg bg-indigo-50 border-2 border-indigo-200">
                            <svg class="w-5 h-5 text-indigo-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span class="font-bold text-indigo-900" x-text="currentIngredient.name"></span>
                            <button
                                type="button"
                                @click="currentIngredient = { id: null, name: '', quantity: null, unit: '', customUnit: '', category: '' }"
                                class="ml-3 text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 rounded-full p-1"
                                title="Auswahl löschen"
                            >
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Menge -->
                    <div>
                        <label class="form-label text-base">
                            <span class="text-gray-900">Menge</span> <span class="text-red-500 text-lg">*</span>
                        </label>
                        <p class="form-help mb-2">Geben Sie die Menge für die ausgewählte Zutat ein.</p>
                        <input
                            type="number"
                            x-model.number="currentIngredient.quantity"
                            class="form-input"
                            step="0.1"
                            min="0"
                            placeholder="z.B. 500"
                        >
                    </div>

                    <!-- Einheit -->
                    <div>
                        <label class="form-label text-base">
                            <span class="text-gray-900">Einheit</span> <span class="text-red-500 text-lg">*</span>
                        </label>
                        <p class="form-help mb-2">Wählen Sie die passende Einheit für die Menge.</p>
                        <select
                            x-model="currentIngredient.unit"
                            @change="if ($event.target.value === 'custom') { currentIngredient.unit = ''; $nextTick(() => $refs.customUnit.focus()); }"
                            class="form-select"
                        >
                            <option value="">Bitte wählen...</option>
                            <option value="g">g (Gramm)</option>
                            <option value="kg">kg (Kilogramm)</option>
                            <option value="ml">ml (Milliliter)</option>
                            <option value="L">L (Liter)</option>
                            <option value="Stück">Stück</option>
                            <option value="EL">EL (Esslöffel)</option>
                            <option value="TL">TL (Teelöffel)</option>
                            <option value="Prise">Prise</option>
                            <option value="Bund">Bund</option>
                            <option value="Dose">Dose</option>
                            <option value="Packung">Packung</option>
                            <option value="custom">➕ Eigene Einheit...</option>
                        </select>
                        <!-- Custom Unit Input -->
                        <input
                            x-show="currentIngredient.unit === ''"
                            x-ref="customUnit"
                            type="text"
                            @input="currentIngredient.customUnit = $event.target.value"
                            class="form-input mt-2"
                            placeholder="Eigene Einheit eingeben"
                        >
                    </div>

                    <!-- Add Button -->
                    <div class="flex justify-start mt-4">
                        <button
                            type="button"
                            @click="addIngredient"
                            class="inline-flex items-center justify-center px-6 py-3 text-base font-bold rounded-xl
                                   text-white bg-gradient-to-r from-teal-600 to-emerald-600
                                   hover:from-teal-700 hover:to-emerald-700 hover:shadow-2xl
                                   active:from-teal-800 active:to-emerald-800
                                   focus:ring-4 focus:ring-teal-300
                                   transition-all duration-200 transform hover:scale-105 active:scale-95
                                   disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                            :disabled="!canAddIngredient()"
                            :class="{ 'opacity-50 cursor-not-allowed': !canAddIngredient() }"
                        >
                            <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
                            </svg>
                            Zutat hinzufügen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ingredients List (Sortable) -->
            <div x-show="formData.ingredients.length > 0" x-cloak>
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                    Zutatenliste (<span x-text="formData.ingredients.length"></span>)
                </h3>

                <!-- Grouped by Category -->
                <div id="ingredients-container" class="space-y-4">
                    <template x-for="category in getIngredientCategories()" :key="category">
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 border-2 border-gray-200">
                            <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase tracking-wide" x-text="category"></h4>
                            <div class="space-y-2" :data-category="category">
                                <template x-for="(ingredient, index) in getIngredientsByCategory(category)" :key="index">
                                    <div
                                        class="bg-white rounded-lg p-4 border-2 border-gray-200 hover:border-indigo-300 transition-all cursor-move flex items-center justify-between shadow-sm hover:shadow-md"
                                        :data-ingredient-index="formData.ingredients.indexOf(ingredient)"
                                    >
                                        <div class="flex items-center flex-1">
                                            <!-- Drag Handle -->
                                            <svg class="w-5 h-5 text-gray-400 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                                            </svg>

                                            <!-- Ingredient Info -->
                                            <div class="flex-1">
                                                <p class="font-bold text-gray-900" x-text="ingredient.name"></p>
                                                <p class="text-sm text-gray-600" x-text="ingredient.quantity + ' ' + ingredient.unit"></p>
                                            </div>
                                        </div>

                                        <!-- Delete Button -->
                                        <button
                                            type="button"
                                            @click="removeIngredient(formData.ingredients.indexOf(ingredient))"
                                            class="ml-4 p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                        >
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- No Ingredients Message -->
            <div x-show="formData.ingredients.length === 0" x-cloak class="alert alert-info">
                <p class="text-sm">Noch keine Zutaten hinzugefügt. Fügen Sie mindestens eine Zutat hinzu.</p>
            </div>

            <p x-show="errors.ingredients" x-text="errors.ingredients" class="form-error mt-4"></p>
        </div>

        <!-- Section 4: Zubereitung -->
        <div class="card">
            <div class="card-header">
                <h2 class="text-2xl font-extrabold text-gray-900 flex items-center">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 font-bold mr-4 text-lg">4</span>
                    Zubereitung <span class="text-red-500">*</span>
                </h2>
            </div>

            <div class="form-group">
                <label for="instructions" class="form-label text-base">
                    <span class="text-gray-900">Zubereitung - Schritt für Schritt</span> <span class="text-red-500 text-lg">*</span>
                </label>
                <p class="form-help mb-2">Beschreiben Sie die Zubereitungsschritte detailliert. Jeder Schritt sollte klar verständlich sein.</p>
                <textarea
                    id="instructions"
                    name="instructions"
                    x-model="formData.instructions"
                    class="form-textarea"
                    rows="10"
                    placeholder="z.B.&#10;1. Zwiebeln fein würfeln und in Öl anbraten...&#10;2. Hackfleisch hinzugeben und krümelig braten...&#10;3. Tomaten und Gewürze hinzufügen..."
                    required
                ></textarea>
                <p x-show="errors.instructions" x-text="errors.instructions" class="form-error"></p>
            </div>
        </div>

        <!-- Section 5: Zusätzliche Informationen -->
        <div class="card">
            <div class="card-header">
                <h2 class="text-2xl font-extrabold text-gray-900 flex items-center">
                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 font-bold mr-4 text-lg">5</span>
                    Zusätzliche Informationen
                </h2>
            </div>

            <div class="space-y-6">
                <!-- Tags -->
                <div class="form-group">
                    <label class="form-label text-base">
                        <span class="text-gray-900">Tags & Kategorien</span>
                    </label>
                    <p class="form-help mb-2">Wählen Sie passende Tags aus, um das Rezept zu kategorisieren.</p>
                    <div class="flex flex-wrap gap-3">
                        {% for tag in tags %}
                        <label class="flex items-center cursor-pointer">
                            <input
                                type="checkbox"
                                name="tags"
                                value="{{ tag.id }}"
                                x-model="formData.tag_ids"
                                class="form-checkbox mr-2"
                            >
                            <span class="badge" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border-color: {{ tag.color }}40;">
                                {{ tag.name }}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Allergen Notes -->
                <div class="form-group">
                    <label for="allergen_notes" class="form-label text-base">
                        <span class="text-gray-900">Allergen-Hinweise</span>
                    </label>
                    <p class="form-help mb-2">Optional: Spezielle Hinweise zu Allergenen oder Unverträglichkeiten.</p>
                    <textarea
                        id="allergen_notes"
                        name="allergen_notes"
                        x-model="formData.allergen_notes"
                        class="form-textarea"
                        rows="5"
                        placeholder="z.B. Enthält Gluten, Laktose und Sellerie. Kann durch glutenfreie Nudeln ersetzt werden..."
                    ></textarea>
                </div>
            </div>
        </div>

        <!-- Form Actions - Sticky Footer -->
        <div class="sticky bottom-0 z-40 mt-8">
            <div class="card bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-300 shadow-2xl">
                <div class="flex flex-col lg:flex-row items-center justify-between gap-4">
                    <!-- Info Section -->
                    <div class="text-center lg:text-left">
                        <p class="text-sm font-semibold text-gray-700">
                            <span class="text-red-500 text-lg">*</span> Pflichtfelder
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            <span class="font-semibold">Version {{ recipe.version_number }}</span>
                            <svg class="w-4 h-4 inline mx-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                            <span class="font-semibold text-indigo-600">Version {{ recipe.version_number + 1 }}</span>
                        </p>
                    </div>

                    <!-- Buttons -->
                    <div class="flex items-center space-x-3">
                        <a
                            href="/recipes/{{ recipe.id }}"
                            class="inline-flex items-center justify-center px-6 py-3.5 text-base font-bold rounded-xl
                                   text-white bg-gradient-to-r from-red-600 to-rose-600
                                   hover:from-red-700 hover:to-rose-700 hover:shadow-2xl
                                   active:from-red-800 active:to-rose-800
                                   focus:ring-4 focus:ring-red-300
                                   transition-all duration-200 transform hover:scale-105 active:scale-95"
                        >
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            Abbrechen
                        </a>
                        <button
                            type="submit"
                            class="inline-flex items-center justify-center px-8 py-3.5 text-base font-bold rounded-xl
                                   text-white bg-gradient-to-r from-indigo-600 to-purple-600
                                   hover:from-indigo-700 hover:to-purple-700 hover:shadow-2xl
                                   active:from-indigo-800 active:to-purple-800
                                   focus:ring-4 focus:ring-indigo-300
                                   transition-all duration-200 transform hover:scale-105 active:scale-95
                                   disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                            :disabled="isSubmitting"
                        >
                            <svg x-show="!isSubmitting" class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <svg x-show="isSubmitting" class="animate-spin w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span x-show="!isSubmitting">Änderungen speichern</span>
                            <span x-show="isSubmitting">Speichern...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- New Ingredient Modal -->
    <div
        x-data="{ showModal: false }"
        @open-new-ingredient-modal.window="showModal = true"
        @close-new-ingredient-modal.window="showModal = false"
        x-show="showModal"
        x-cloak
        class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
        @click.self="showModal = false"
    >
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6" @click.stop>
            <div class="modal-header">
                <h3 class="modal-title">Neue Zutat erstellen</h3>
                <button @click="showModal = false" class="modal-close">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>

            <form @submit.prevent="createNewIngredient" x-data="newIngredientForm()">
                <div class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">Name <span class="text-red-500">*</span></label>
                        <input type="text" x-model="newIngredient.name" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Einheit <span class="text-red-500">*</span></label>
                        <input type="text" x-model="newIngredient.unit" class="form-input" placeholder="z.B. kg, g, L..." required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Kategorie <span class="text-red-500">*</span></label>
                        <select x-model="newIngredient.category" class="form-select" required>
                            <option value="">Bitte wählen...</option>
                            <option value="Gemüse">Gemüse</option>
                            <option value="Obst">Obst</option>
                            <option value="Fleisch">Fleisch</option>
                            <option value="Fisch">Fisch</option>
                            <option value="Milchprodukte">Milchprodukte</option>
                            <option value="Backwaren">Backwaren</option>
                            <option value="Getreide">Getreide</option>
                            <option value="Gewürze">Gewürze</option>
                            <option value="Öle & Fette">Öle & Fette</option>
                            <option value="Sonstiges">Sonstiges</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" @click="showModal = false" class="btn btn-secondary">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Erstellen</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Recipe data from server
const RECIPE_DATA = {
    id: {{ recipe.id }},
    name: {{ recipe.name|tojson|safe }},
    description: {{ (recipe.description|tojson if recipe.description else '""')|safe }},
    base_servings: {{ recipe.base_servings }},
    preparation_time: {{ recipe.preparation_time if recipe.preparation_time else 'null' }},
    cooking_time: {{ recipe.cooking_time if recipe.cooking_time else 'null' }},
    instructions: {{ (recipe.instructions|tojson if recipe.instructions else '""')|safe }},
    allergen_notes: {{ (recipe.allergen_notes|tojson if recipe.allergen_notes else '""')|safe }},
    ingredients: [
        {% for ri in recipe.ingredients %}
        {
            ingredient_id: {{ ri.ingredient.id }},
            name: {{ ri.ingredient.name|tojson|safe }},
            quantity: {{ ri.quantity }},
            unit: {{ ri.unit|tojson|safe }},
            category: {{ ri.ingredient.category|tojson|safe }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    tag_ids: [{% for tag in recipe.tags %}{{ tag.id }}{% if not loop.last %},{% endif %}{% endfor %}]
};

// Autocomplete Component
function ingredientAutocomplete() {
    return {
        search: '',
        suggestions: [],
        showSuggestions: false,
        selectedIndex: -1,

        async searchIngredients() {
            if (this.search.length < 1) {
                this.suggestions = [];
                this.showSuggestions = false;
                return;
            }

            try {
                const response = await fetch(`/recipes/api/ingredients/search?q=${encodeURIComponent(this.search)}`);
                this.suggestions = await response.json();
                this.showSuggestions = true;
                this.selectedIndex = -1;
            } catch (error) {
                console.error('Search failed:', error);
            }
        },

        selectSuggestion(suggestion) {
            console.log('Selecting suggestion:', suggestion);

            // Event-basierter Ansatz statt direktem Zugriff
            window.dispatchEvent(new CustomEvent('ingredient-selected', {
                detail: {
                    id: suggestion.id,
                    name: suggestion.name,
                    unit: suggestion.unit,
                    category: suggestion.category
                }
            }));

            // Suchfeld leeren und Dropdown schließen
            this.search = '';
            this.suggestions = [];
            this.showSuggestions = false;
        },

        navigateDown() {
            if (this.selectedIndex < this.suggestions.length - 1) {
                this.selectedIndex++;
            }
        },

        navigateUp() {
            if (this.selectedIndex > 0) {
                this.selectedIndex--;
            }
        },

        selectCurrent() {
            if (this.selectedIndex >= 0 && this.selectedIndex < this.suggestions.length) {
                this.selectSuggestion(this.suggestions[this.selectedIndex]);
            }
        },

        openNewIngredientModal() {
            window.dispatchEvent(new CustomEvent('open-new-ingredient-modal', {
                detail: { name: this.search }
            }));
        }
    };
}

// New Ingredient Form
function newIngredientForm() {
    return {
        newIngredient: {
            name: '',
            unit: '',
            category: ''
        },

        init() {
            window.addEventListener('open-new-ingredient-modal', (e) => {
                this.newIngredient.name = e.detail?.name || '';
            });
        },

        async createNewIngredient() {
            try {
                const formData = new FormData();
                formData.append('name', this.newIngredient.name);
                formData.append('unit', this.newIngredient.unit);
                formData.append('category', this.newIngredient.category);

                const response = await fetch('/recipes/api/ingredients/quick-create', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const ingredient = await response.json();

                    // Direkt das Parent-Form-Element finden
                    const formElement = document.getElementById('recipe-form');
                    if (formElement && formElement.__x && formElement.__x.$data) {
                        formElement.__x.$data.currentIngredient = {
                            id: ingredient.id,
                            name: ingredient.name,
                            quantity: null,
                            unit: ingredient.unit,
                            customUnit: '',
                            category: ingredient.category
                        };
                        console.log('New ingredient created and selected:', ingredient);
                    }

                    // Close modal
                    window.dispatchEvent(new CustomEvent('close-new-ingredient-modal'));

                    // Reset form
                    this.newIngredient = { name: '', unit: '', category: '' };

                    FreizeitApp.showToast('Zutat erfolgreich erstellt!', 'success');
                } else {
                    const error = await response.json();
                    FreizeitApp.showToast(error.error || 'Fehler beim Erstellen der Zutat', 'error');
                }
            } catch (error) {
                console.error('Error creating ingredient:', error);
                FreizeitApp.showToast('Fehler beim Erstellen der Zutat', 'error');
            }
        }
    };
}

// Main Recipe Form
function recipeForm() {
    return {
        formData: {
            name: '',
            description: '',
            base_servings: 30,
            preparation_time: null,
            cooking_time: null,
            instructions: '',
            ingredients: [],
            tag_ids: [],
            allergen_notes: ''
        },
        currentIngredient: {
            id: null,
            name: '',
            quantity: null,
            unit: '',
            customUnit: '',
            category: ''
        },
        errors: {},
        isSubmitting: false,
        sortable: null,

        init() {
            // Load existing recipe data
            this.formData = {
                name: RECIPE_DATA.name,
                description: RECIPE_DATA.description,
                base_servings: RECIPE_DATA.base_servings,
                preparation_time: RECIPE_DATA.preparation_time,
                cooking_time: RECIPE_DATA.cooking_time,
                instructions: RECIPE_DATA.instructions,
                ingredients: RECIPE_DATA.ingredients,
                tag_ids: RECIPE_DATA.tag_ids,
                allergen_notes: RECIPE_DATA.allergen_notes
            };

            // Initialize Sortable.js for drag & drop
            this.$nextTick(() => {
                this.initializeSortable();
            });

            // Watch for ingredient changes to re-init sortable
            this.$watch('formData.ingredients', () => {
                this.$nextTick(() => {
                    this.initializeSortable();
                });
            });

            // Event-Listener für Zutat-Auswahl aus Autocomplete
            window.addEventListener('ingredient-selected', (event) => {
                console.log('Ingredient selected via event:', event.detail);
                this.currentIngredient = {
                    id: event.detail.id,
                    name: event.detail.name,
                    quantity: null,
                    unit: event.detail.unit,
                    customUnit: '',
                    category: event.detail.category
                };
                console.log('currentIngredient updated:', this.currentIngredient);
            });
        },

        initializeSortable() {
            const categories = this.getIngredientCategories();

            categories.forEach(category => {
                const container = document.querySelector(`[data-category="${category}"]`);
                if (container) {
                    // Destroy existing instance if present
                    if (container.sortableInstance) {
                        container.sortableInstance.destroy();
                    }

                    const sortableInstance = Sortable.create(container, {
                        animation: 200,
                        handle: 'svg',
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        onEnd: (evt) => {
                            // Get the actual indices from the data attributes
                            const items = container.querySelectorAll('[data-ingredient-index]');
                            const newOrder = [];

                            // Build new order based on DOM order
                            items.forEach(item => {
                                const originalIndex = parseInt(item.getAttribute('data-ingredient-index'));
                                newOrder.push(this.formData.ingredients[originalIndex]);
                            });

                            // Rebuild the ingredients array: keep other categories, replace this category
                            const otherIngredients = this.formData.ingredients.filter(
                                ing => ing.category !== category
                            );

                            this.formData.ingredients = [...otherIngredients, ...newOrder];

                            console.log('Reordered ingredients:', this.formData.ingredients);
                        }
                    });
                    container.sortableInstance = sortableInstance;
                }
            });
        },

        canAddIngredient() {
            return this.currentIngredient.id &&
                   this.currentIngredient.quantity > 0 &&
                   (this.currentIngredient.unit !== '' || this.currentIngredient.customUnit !== '');
        },

        addIngredient() {
            console.log('addIngredient called', this.currentIngredient);

            if (!this.canAddIngredient()) {
                console.log('Cannot add ingredient:', {
                    hasId: !!this.currentIngredient.id,
                    hasQuantity: this.currentIngredient.quantity > 0,
                    hasUnit: this.currentIngredient.unit !== '' || this.currentIngredient.customUnit !== ''
                });
                FreizeitApp.showToast('Bitte alle Felder ausfüllen', 'warning');
                return;
            }

            const finalUnit = this.currentIngredient.unit === ''
                ? this.currentIngredient.customUnit
                : this.currentIngredient.unit;

            this.formData.ingredients.push({
                ingredient_id: this.currentIngredient.id,
                name: this.currentIngredient.name,
                quantity: this.currentIngredient.quantity,
                unit: finalUnit,
                category: this.currentIngredient.category
            });

            console.log('Ingredient added successfully');
            FreizeitApp.showToast('Zutat hinzugefügt!', 'success');

            // Reset current ingredient
            this.currentIngredient = {
                id: null,
                name: '',
                quantity: null,
                unit: '',
                customUnit: '',
                category: ''
            };
        },

        removeIngredient(index) {
            this.formData.ingredients.splice(index, 1);
        },

        getIngredientCategories() {
            const categories = [...new Set(this.formData.ingredients.map(i => i.category))];
            return categories.sort();
        },

        getIngredientsByCategory(category) {
            return this.formData.ingredients.filter(i => i.category === category);
        },

        validateForm() {
            this.errors = {};

            if (!this.formData.name || this.formData.name.trim() === '') {
                this.errors.name = 'Name ist erforderlich';
            }

            if (this.formData.ingredients.length === 0) {
                this.errors.ingredients = 'Mindestens eine Zutat ist erforderlich';
            }

            if (!this.formData.instructions || this.formData.instructions.trim() === '') {
                this.errors.instructions = 'Anleitung ist erforderlich';
            }

            return Object.keys(this.errors).length === 0;
        },

        async submitForm() {
            if (!this.validateForm()) {
                FreizeitApp.showToast('Bitte füllen Sie alle Pflichtfelder aus', 'error');
                return;
            }

            this.isSubmitting = true;

            try {
                const formData = new FormData();
                formData.append('name', this.formData.name);
                formData.append('description', this.formData.description || '');
                formData.append('base_servings', this.formData.base_servings);

                // Only append preparation_time and cooking_time if they have values
                if (this.formData.preparation_time !== null && this.formData.preparation_time !== '') {
                    formData.append('preparation_time', this.formData.preparation_time);
                }
                if (this.formData.cooking_time !== null && this.formData.cooking_time !== '') {
                    formData.append('cooking_time', this.formData.cooking_time);
                }

                formData.append('instructions', this.formData.instructions);
                formData.append('allergen_notes', this.formData.allergen_notes || '');

                // Add ingredients as JSON
                formData.append('ingredients', JSON.stringify(
                    this.formData.ingredients.map(ing => ({
                        ingredient_id: ing.ingredient_id,
                        quantity: ing.quantity,
                        unit: ing.unit
                    }))
                ));

                // Add tags
                formData.append('tag_ids', JSON.stringify(this.formData.tag_ids));

                const response = await fetch('/recipes/{{ recipe.id }}', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    FreizeitApp.showToast('Rezept erfolgreich aktualisiert!', 'success');

                    // Redirect to recipe detail
                    setTimeout(() => {
                        window.location.href = '/recipes/{{ recipe.id }}';
                    }, 1000);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Server error:', errorData);
                    throw new Error(errorData.detail || 'Server error');
                }
            } catch (error) {
                console.error('Submit failed:', error);
                FreizeitApp.showToast('Fehler beim Speichern des Rezepts: ' + error.message, 'error');
            } finally {
                this.isSubmitting = false;
            }
        }
    };
}
</script>
{% endblock %}
