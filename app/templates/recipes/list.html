{% extends "base.html" %}

{% block title %}Rezepte - {{ current_camp.name }}{% endblock %}

{% block content %}
<div class="space-y-6" x-data="recipeList()">
    <!-- Statistics Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
        <!-- Total Recipes -->
        <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-6 hover:shadow-lg transition-all">
            <div class="flex items-start justify-end mb-3">
                <div class="p-2 bg-white rounded-lg shadow-sm">
                    <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                </div>
            </div>
            <div class="text-2xl font-bold text-indigo-900 mb-1" x-text="filteredCount"></div>
            <div class="text-sm font-medium text-indigo-700 mb-2">Rezepte</div>
            <div class="text-xs text-indigo-600" x-show="filteredCount !== {{ recipes|length }}">
                von {{ recipes|length }} gesamt
            </div>
            <div class="text-xs text-indigo-600" x-show="filteredCount === {{ recipes|length }}">
                Gesamt
            </div>
        </div>

        <!-- Average Time -->
        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg p-6 hover:shadow-lg transition-all">
            <div class="flex items-start justify-end mb-3">
                <div class="p-2 bg-white rounded-lg shadow-sm">
                    <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                    </svg>
                </div>
            </div>
            <div class="text-2xl font-bold text-emerald-900 mb-1">
                {% set total_time = recipes | map(attribute='preparation_time') | select('number') | sum + recipes | map(attribute='cooking_time') | select('number') | sum %}
                {% set avg_time = (total_time / recipes|length) | int if recipes|length > 0 else 0 %}
                {{ avg_time }} min
            </div>
            <div class="text-sm font-medium text-emerald-700 mb-2">√ò Zeit</div>
            <div class="text-xs text-emerald-600">Durchschnittliche Dauer</div>
        </div>

        <!-- Average Servings -->
        <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-lg p-6 hover:shadow-lg transition-all">
            <div class="flex items-start justify-end mb-3">
                <div class="p-2 bg-white rounded-lg shadow-sm">
                    <svg class="w-6 h-6 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                </div>
            </div>
            <div class="text-2xl font-bold text-amber-900 mb-1">
                {% set avg_servings = (recipes | map(attribute='base_servings') | sum / recipes|length) | int if recipes|length > 0 else 0 %}
                {{ avg_servings }}
            </div>
            <div class="text-sm font-medium text-amber-700 mb-2">√ò Portionen</div>
            <div class="text-xs text-amber-600">Pro Rezept</div>
        </div>

        <!-- Tags Count -->
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-6 hover:shadow-lg transition-all">
            <div class="flex items-start justify-end mb-3">
                <div class="p-2 bg-white rounded-lg shadow-sm">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                </div>
            </div>
            <div class="text-2xl font-bold text-purple-900 mb-1">{{ tags|length }}</div>
            <div class="text-sm font-medium text-purple-700 mb-2">Tags</div>
            <div class="text-xs text-purple-600">Verf√ºgbar</div>
        </div>
    </div>

    <!-- Toolbar: Search & Sort -->
    <div class="card">
        <div class="flex flex-col md:flex-row items-stretch md:items-center gap-4">
            <!-- Livesearch -->
            <div class="flex-1">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input
                        type="text"
                        x-model="searchQuery"
                        @input.debounce.300ms="applyFilters()"
                        placeholder="Rezept suchen... (Live-Suche)"
                        class="form-input pl-12 pr-9"
                    >
                    <div class="absolute inset-y-0 right-0 pr-4 flex items-center">
                        <button
                            x-show="searchQuery"
                            @click="searchQuery = ''; applyFilters()"
                            class="text-gray-400 hover:text-gray-600"
                        >
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sort Options -->
            <div class="flex items-center space-x-3">
                <label class="text-sm font-bold text-gray-800 flex-shrink-0">Sortierung:</label>
                <select
                    x-model="sortBy"
                    @change="applySort()"
                    class="form-select w-48"
                >
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="time-asc">Zeit (wenig ‚Üí viel)</option>
                    <option value="time-desc">Zeit (viel ‚Üí wenig)</option>
                    <option value="servings-asc">Portionen (wenig ‚Üí viel)</option>
                    <option value="servings-desc">Portionen (viel ‚Üí wenig)</option>
                    <option value="created-desc">Neueste zuerst</option>
                    <option value="created-asc">√Ñlteste zuerst</option>
                </select>
            </div>

            <!-- Filter Toggle -->
            <button
                @click="showFilters = !showFilters"
                class="btn-fab btn-fab-secondary"
                :class="hasActiveFilters() ? 'ring-2 ring-indigo-400' : ''"
            >
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd"/>
                </svg>
                Filter
                <span x-show="hasActiveFilters()" class="ml-2 bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">
                    <span x-text="getActiveFilterCount()"></span>
                </span>
            </button>
        </div>
    </div>

    <!-- Collapsible Filters -->
    <div x-show="showFilters" x-collapse class="card">
        <div class="card-header">
            <h2 class="card-title flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd"/>
                </svg>
                Filter
            </h2>
            <button @click="clearFilters()" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold">
                Alle zur√ºcksetzen
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Tag Filter -->
            <div>
                <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                    Tags filtern
                </label>
                <div class="space-y-2 max-h-48 overflow-y-auto rounded-lg p-4 bg-gray-50 shadow-inner">
                    {% if tags %}
                        {% for tag in tags %}
                        <label class="flex items-center space-x-3 cursor-pointer hover:bg-white p-2 rounded-lg transition-colors">
                            <input
                                type="checkbox"
                                value="{{ tag.id }}"
                                @change="applyFilters()"
                                x-model="selectedTags"
                                class="form-checkbox"
                            >
                            <span class="badge" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border-color: {{ tag.color }}40;">
                                {% if tag.icon %}{{ tag.icon }}{% endif %} {{ tag.name }}
                            </span>
                        </label>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-gray-500 font-medium">Keine Tags verf√ºgbar</p>
                    {% endif %}
                </div>
            </div>

            <!-- Allergen Filter -->
            <div>
                <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    Allergene ausschlie√üen
                </label>
                <div class="space-y-2 max-h-48 overflow-y-auto rounded-lg p-4 bg-gray-50 shadow-inner">
                    {% if allergens %}
                        {% for allergen in allergens %}
                        <label class="flex items-center space-x-3 cursor-pointer hover:bg-white p-2 rounded-lg transition-colors">
                            <input
                                type="checkbox"
                                value="{{ allergen.id }}"
                                @change="applyFilters()"
                                x-model="selectedAllergens"
                                class="form-checkbox"
                            >
                            <span class="text-sm font-medium text-gray-900">
                                {% if allergen.icon %}{{ allergen.icon }}{% endif %} {{ allergen.name }}
                            </span>
                        </label>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-gray-500 font-medium">Keine Allergene verf√ºgbar</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Active Filters Summary -->
        <div x-show="hasActiveFilters()" class="mt-6 p-4 bg-indigo-50 rounded-lg border-2 border-indigo-200">
            <div class="flex items-center justify-between">
                <div class="flex flex-wrap gap-2">
                    <template x-if="selectedTags.length > 0">
                        <span class="badge badge-primary">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                            </svg>
                            <span x-text="selectedTags.length + ' Tag(s)'"></span>
                        </span>
                    </template>
                    <template x-if="selectedAllergens.length > 0">
                        <span class="badge badge-danger">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                            <span x-text="selectedAllergens.length + ' Allergen(e)'"></span>
                        </span>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Recipes Table -->
    <div class="card p-0 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gradient-to-r from-indigo-50 to-purple-50">
                    <tr>
                        <th scope="col" class="px-6 py-4 text-left text-xs font-black text-gray-900 uppercase tracking-wider">
                            Rezeptname
                        </th>
                        <th scope="col" class="px-6 py-4 text-left text-xs font-black text-gray-900 uppercase tracking-wider hidden md:table-cell">
                            Beschreibung
                        </th>
                        <th scope="col" class="px-6 py-4 text-center text-xs font-black text-gray-900 uppercase tracking-wider">
                            Portionen
                        </th>
                        <th scope="col" class="px-6 py-4 text-center text-xs font-black text-gray-900 uppercase tracking-wider">
                            Zeit
                        </th>
                        <th scope="col" class="px-6 py-4 text-left text-xs font-black text-gray-900 uppercase tracking-wider hidden lg:table-cell">
                            Tags
                        </th>
                        <th scope="col" class="px-6 py-4 text-center text-xs font-black text-gray-900 uppercase tracking-wider">
                            Aktionen
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
        {% for recipe in recipes %}
                    <tr data-recipe-id="{{ recipe.id }}"
                        data-recipe-name="{{ recipe.name|lower }}"
                        data-recipe-tags="{{ recipe.tags | map(attribute='id') | list | join(',') }}"
                        data-recipe-allergens="{{ recipe.allergens | map(attribute='id') | list | join(',') }}"
                        data-recipe-time="{{ (recipe.preparation_time or 0) + (recipe.cooking_time or 0) }}"
                        data-recipe-servings="{{ recipe.base_servings }}"
                        data-recipe-created="{{ recipe.created_at }}"
                        x-show="isRecipeVisible({{ recipe.id }}, '{{ recipe.name|lower }}', '{{ recipe.tags | map(attribute='id') | list | join(',') }}', '{{ recipe.allergens | map(attribute='id') | list | join(',') }}')"
                        class="hover:bg-indigo-50 transition-all duration-200 cursor-pointer group"
                        @click="window.location.href = '/recipes/{{ recipe.id }}'"
                    >
                        <!-- Name -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-12 w-12">
                                    {% if recipe.image_path %}
                                    <img class="h-12 w-12 rounded-lg object-cover shadow-md group-hover:shadow-lg transition-shadow" src="{{ recipe.image_path }}" alt="{{ recipe.name }}">
                                    {% else %}
                                    <div class="h-12 w-12 rounded-lg bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center text-2xl shadow-md group-hover:shadow-lg transition-shadow">
                                        üçΩÔ∏è
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-bold text-gray-900 group-hover:text-indigo-600 transition-colors">{{ recipe.name }}</div>
                                    {% if recipe.allergens %}
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        {% for allergen in recipe.allergens[:2] %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-50 text-red-700 border border-red-200">
                                            {% if allergen.icon %}{{ allergen.icon }}{% endif %}
                                        </span>
                                        {% endfor %}
                                        {% if recipe.allergens|length > 2 %}
                                        <span class="text-xs text-red-600 font-bold">+{{ recipe.allergens|length - 2 }}</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <!-- Description -->
                        <td class="px-6 py-4 hidden md:table-cell">
                            <div class="text-sm text-gray-700 max-w-xs line-clamp-2">
                                {{ recipe.description or 'Keine Beschreibung' }}
                            </div>
                        </td>
                        <!-- Servings -->
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <div class="flex flex-col items-center">
                                <svg class="w-5 h-5 text-gray-400 mb-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                                </svg>
                                <span class="text-sm font-bold text-gray-900">{{ recipe.base_servings }}</span>
                            </div>
                        </td>
                        <!-- Time -->
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            {% if recipe.preparation_time or recipe.cooking_time %}
                            <div class="flex flex-col items-center">
                                <svg class="w-5 h-5 text-gray-400 mb-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-sm font-bold text-gray-900">{{ (recipe.preparation_time or 0) + (recipe.cooking_time or 0) }}</span>
                                <span class="text-xs text-gray-500">min</span>
                            </div>
                            {% else %}
                            <span class="text-sm text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <!-- Tags -->
                        <td class="px-6 py-4 hidden lg:table-cell">
                            {% if recipe.tags %}
                            <div class="flex flex-wrap gap-1">
                                {% for tag in recipe.tags[:2] %}
                                <span class="badge" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border-color: {{ tag.color }}40;">
                                    {% if tag.icon %}{{ tag.icon }}{% endif %} {{ tag.name }}
                                </span>
                                {% endfor %}
                                {% if recipe.tags|length > 2 %}
                                <span class="badge badge-info">
                                    +{{ recipe.tags|length - 2 }}
                                </span>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-sm text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <!-- Actions -->
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium" @click.stop>
                            <div class="flex items-center justify-center space-x-2">
                                <a href="/recipes/{{ recipe.id }}" class="p-2 text-indigo-600 hover:bg-indigo-100 rounded-lg transition-colors" title="Details">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </a>
                                <a href="/recipes/{{ recipe.id }}/edit" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors" title="Bearbeiten">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                    </svg>
                                </a>
                                <button @click="deleteRecipe({{ recipe.id }}, '{{ recipe.name }}')" class="p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors" title="L√∂schen">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
        {% endfor %}

                </tbody>
            </table>
        </div>
    </div>

    {% if not recipes %}
    <!-- Empty State -->
    <div class="text-center py-16">
        <div class="card">
            <svg class="w-24 h-24 mx-auto mb-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            <h3 class="text-2xl font-black text-gray-900 mb-3">Noch keine Rezepte</h3>
            <p class="text-gray-600 mb-8 max-w-md mx-auto text-lg">
                Erstellen Sie Ihr erstes Rezept, um loszulegen.
                Rezepte k√∂nnen in der Mahlzeitenplanung verwendet werden.
            </p>
            <a href="/recipes/create" class="btn btn-primary inline-flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
                Erstes Rezept erstellen
            </a>
        </div>
    </div>
    {% endif %}

    <!-- No Results Message -->
    <div x-show="filteredCount === 0 && {{ recipes|length }} > 0" x-cloak class="text-center py-16">
        <div class="card">
            <svg class="w-24 h-24 mx-auto mb-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <h3 class="text-2xl font-black text-gray-900 mb-3">Keine Ergebnisse</h3>
            <p class="text-gray-600 mb-8 text-lg">
                F√ºr die ausgew√§hlten Filter wurden keine Rezepte gefunden.
            </p>
            <button @click="clearFilters()" class="btn btn-secondary">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                </svg>
                Filter zur√ºcksetzen
            </button>
        </div>
    </div>

</div>

{% block fab %}
<div class="fab-container">
    <!-- Export Rezeptliste (PDF) - Secondary FAB -->
    <a href="/export/recipes/pdf"
       class="fab-extended fab-extended-accent"
       title="Rezeptliste exportieren (PDF)">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"></path>
        </svg>
        <span>PDF Export</span>
    </a>

    <!-- Create Recipe - Primary FAB -->
    <a href="/recipes/create"
       class="fab-extended fab-extended-primary"
       title="Neues Rezept erstellen">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
        </svg>
        <span>Neues Rezept</span>
    </a>
</div>
{% endblock %}

<script>
function recipeList() {
    return {
        searchQuery: '',
        selectedTags: [],
        selectedAllergens: [],
        filteredCount: {{ recipes|length }},
        sortBy: 'name-asc',
        showFilters: false,

        init() {
            this.updateFilteredCount();
        },

        applyFilters() {
            this.updateFilteredCount();
        },

        applySort() {
            const tbody = document.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr[data-recipe-id]'));

            rows.sort((a, b) => {
                const [field, direction] = this.sortBy.split('-');
                let aVal, bVal;

                switch(field) {
                    case 'name':
                        aVal = a.dataset.recipeName;
                        bVal = b.dataset.recipeName;
                        break;
                    case 'time':
                        aVal = parseInt(a.dataset.recipeTime) || 0;
                        bVal = parseInt(b.dataset.recipeTime) || 0;
                        break;
                    case 'servings':
                        aVal = parseInt(a.dataset.recipeServings) || 0;
                        bVal = parseInt(b.dataset.recipeServings) || 0;
                        break;
                    case 'created':
                        aVal = new Date(a.dataset.recipeCreated);
                        bVal = new Date(b.dataset.recipeCreated);
                        break;
                }

                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        },

        isRecipeVisible(id, name, tagIds, allergenIds) {
            // Search filter
            if (this.searchQuery && !name.includes(this.searchQuery.toLowerCase())) {
                return false;
            }

            // Tag filter (must have at least one selected tag)
            if (this.selectedTags.length > 0) {
                const recipeTags = tagIds ? tagIds.split(',').filter(t => t) : [];
                const hasTag = this.selectedTags.some(selectedTag =>
                    recipeTags.includes(selectedTag.toString())
                );
                if (!hasTag) {
                    return false;
                }
            }

            // Allergen filter (must NOT have any selected allergens)
            if (this.selectedAllergens.length > 0) {
                const recipeAllergens = allergenIds ? allergenIds.split(',').filter(a => a) : [];
                const hasAllergen = this.selectedAllergens.some(selectedAllergen =>
                    recipeAllergens.includes(selectedAllergen.toString())
                );
                if (hasAllergen) {
                    return false;
                }
            }

            return true;
        },

        updateFilteredCount() {
            const recipes = document.querySelectorAll('[data-recipe-id]');
            let count = 0;
            recipes.forEach(recipe => {
                const id = recipe.dataset.recipeId;
                const name = recipe.dataset.recipeName;
                const tags = recipe.dataset.recipeTags;
                const allergens = recipe.dataset.recipeAllergens;
                if (this.isRecipeVisible(id, name, tags, allergens)) {
                    count++;
                }
            });
            this.filteredCount = count;
        },

        hasActiveFilters() {
            return this.searchQuery || this.selectedTags.length > 0 || this.selectedAllergens.length > 0;
        },

        getActiveFilterCount() {
            let count = 0;
            if (this.searchQuery) count++;
            if (this.selectedTags.length > 0) count++;
            if (this.selectedAllergens.length > 0) count++;
            return count;
        },

        clearFilters() {
            this.searchQuery = '';
            this.selectedTags = [];
            this.selectedAllergens = [];
            this.applyFilters();
        },

        async deleteRecipe(recipeId, recipeName) {
            if (!confirm(`M√∂chten Sie das Rezept "${recipeName}" wirklich l√∂schen?`)) {
                return;
            }

            try {
                const response = await fetch(`/recipes/${recipeId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Remove the row from DOM
                    const row = document.querySelector(`[data-recipe-id="${recipeId}"]`);
                    if (row) {
                        row.remove();
                    }
                    this.updateFilteredCount();
                    window.FreizeitApp.showToast(`"${recipeName}" gel√∂scht`, 'success');
                } else {
                    throw new Error('Failed to delete recipe');
                }
            } catch (error) {
                console.error('Error deleting recipe:', error);
                window.FreizeitApp.showToast('Fehler beim L√∂schen des Rezepts', 'error');
            }
        }
    };
}
</script>
{% endblock %}
